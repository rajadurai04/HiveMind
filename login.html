<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge" /> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.png" type="image/png" />
    <title>HiveMIND</title>
    <link rel="stylesheet" href="login.css" />
  </head>
  <body>
    <div class="box">
      <span class="borderline"></span>
      <form>
        <h2>Sign in</h2>
        <div class="inputbox">
          <input type="text" required="required" id="eemail" />
          <span>UserEmail</span>
          <i></i>
        </div>
        <div class="inputbox">
          <input type="password" required="required" id="lpassword" />
          <span>Password</span>
          <i></i>
        </div>
        <div class="links">
          <p>Don't have an Account?</p>
          <a href="./signup.html">Signup</a>
        </div>
        <div class="links">
          <a href="#">Forget Password?</a>
        </div>

        <button type="submit" value="Login" onclick="login()" class="logbtn">
          Login
        </button>
      </form>
    </div>
    <script type="text/javascript">
      let account = null;
      let accessToken = null;
      const connect = async () => {
        if (window.ethereum) {
          await window.ethereum.send("eth_requestAccounts");
          window.w3 = new Web3(window.ethereum);
          var accounts = await w3.eth.getAccounts();
          account = accounts[0];

          accessToken = await authenticate();

          let opts = {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
          };

          let res = await fetch(`/secret`, opts);
          alert(await res.text());
        }
      };

      const authenticate = async () => {
        let res = await fetch(`/nonce?address=${account}`);
        let resBody = await res.json();

        let signature = await w3.eth.personal.sign(resBody.message, account);

        let opts = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${resBody.tempToken}`,
          },
        };

        res = await fetch(`/verify?signature=${signature}`, opts);
        resBody = await res.json();

        console.log(resBody);
        return resBody.token;
      };
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-analytics.js"></script>
    <script src="data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </body>
</html>
